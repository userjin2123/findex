package com.example.findex.domain.Sync_Job_Log.service;

import com.example.findex.common.base.JobResult;
import com.example.findex.common.base.JobType;
import com.example.findex.common.openApi.service.IndexSyncService;
import com.example.findex.domain.Sync_Job_Log.dto.*;
import com.example.findex.domain.Sync_Job_Log.entity.QSyncJobLog;
import com.example.findex.domain.Sync_Job_Log.entity.SyncJobLog;
import com.example.findex.domain.Sync_Job_Log.mapper.SyncJobLogMapper;
import com.example.findex.domain.Sync_Job_Log.repository.SyncJobLogRepository;
import com.example.findex.domain.Sync_Job_Log.repository.SyncJobLogRepositoryCustom;
import com.querydsl.core.BooleanBuilder;
import com.querydsl.core.types.Order;
import com.querydsl.core.types.OrderSpecifier;
import com.querydsl.core.types.dsl.BooleanExpression;
import com.querydsl.jpa.impl.JPAQueryFactory;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Service
@RequiredArgsConstructor
@Slf4j
public class SyncJobLogService implements SyncJobLogRepositoryCustom {

    private final IndexSyncService indexSyncService;
    private final SyncJobLogRepository syncJobLogRepository;
    private final SyncJobLogMapper syncJobLogMapper;
    private final JPAQueryFactory queryFactory;

    /**
     * Ïò§Îäò ÎÇ†ÏßúÏùò Î™®Îì† ÏßÄÏàò/Ï†ïÎ≥¥Î•º Ïó∞ÎèôÌïòÍ≥† Î°úÍ∑∏Î•º Í∏∞Î°ùÌïòÎäî Î©îÏÑúÎìú
     */
    @Transactional
    public List<SyncJobLog> syncAndLogLatestIndexData(String worker, LocalDate date) {
        LocalDate target = date == null ? LocalDate.now() : date;

        List<SyncResult> result = indexSyncService.syncIndexDataByFilter(target, target, null);
        return createLogsFromResult(result, worker);
    }

    /**
     * ÌäπÏ†ï Ï°∞Í±¥Ïóê ÎßûÎäî ÏßÄÏàò Îç∞Ïù¥ÌÑ∞Î•º Ïó∞ÎèôÌïòÍ≥† Î°úÍ∑∏Î•º Í∏∞Î°ùÌïòÎäî Î©îÏÑúÎìú
     */
    @Transactional
    public List<SyncJobLog> syncSpecificIndexDataAndLog(IndexDataSyncRequest request, String worker) {
        List<SyncResult> result = indexSyncService.syncIndexDataByFilter(request.baseDateFrom(), request.baseDateTo(), request.indexInfoIds());

        return createLogsFromResult(result, worker);
    }

    /**
     *
     */
    @Transactional(readOnly = true)
    public CursorPageResponse<SyncJobLogDto> getSyncJobList(SyncJobQueryParams params) {
        CursorPageResponse<SyncJobLog> result = this.search(params);

        // entity -> dto
        List<SyncJobLogDto> list = syncJobLogMapper.toDtoList(result.content());

        return new CursorPageResponse<>(
                list,
                result.nextCursor(),
                result.size(),
                result.totalElements(),
                result.hasNext());
    }

    @Transactional(readOnly = true)
    public SyncJobSummaryDto getSyncJobSummary() {
        QSyncJobLog syncJobLog = QSyncJobLog.syncJobLog;
        LocalDateTime oneWeekAgo = LocalDateTime.now().minusWeeks(1);

        Long successCount = queryFactory
                .select(syncJobLog.count())
                .from(syncJobLog)
                .where(
                        syncJobLog.result.in(JobResult.SUCCESS),
                        syncJobLog.jobTime.after(oneWeekAgo)
                )
                .fetchOne();

        Long failedCount = queryFactory
                .select(syncJobLog.count())
                .from(syncJobLog)
                .where(
                        syncJobLog.result.eq(JobResult.FAILED),
                        syncJobLog.jobTime.after(oneWeekAgo)
                )
                .fetchOne();

        LocalDateTime lastSyncTime = queryFactory
                .select(syncJobLog.jobTime.max())
                .from(syncJobLog)
                .fetchOne();

        return new SyncJobSummaryDto(
                successCount != null ? successCount : 0L,
                failedCount != null ? failedCount : 0L,
                lastSyncTime
        );
    }

    /**
     * Ï§ëÎ≥µ Ï†úÍ±∞Ïö© Ìó¨Ìçº Î©îÏÑúÎìú
     * ÎèôÍ∏∞Ìôî Í≤∞Í≥ºÎ•º Î∞õÏïÑÏÑú SyncJobLog ÏóîÌã∞Ìã∞Î•º ÎßåÎì§Í≥† dbÏóê Ï†ÄÏû•
     */
    private List<SyncJobLog> createLogsFromResult(List<SyncResult> result, String worker) {
        List<SyncJobLog> createdLogs = new ArrayList<>();

        for(SyncResult syncResult : result) {
            if(syncResult.indexInfo() == null) {
                log.warn("Î°úÍ∑∏ Í∏∞Î°ù Ïã§Ìå® : IndexInfoÍ∞Ä ÏóÜÏäµÎãàÎã§. Details : {}", syncResult.details());
                continue;
            }

            SyncJobLog log = SyncJobLog.builder()
                    .jobType(JobType.INDEX_DATA)
                    .targetDate(syncResult.targetDate())
                    .worker(worker)
                    .jobTime(LocalDateTime.now())
                    .indexInfo(syncResult.indexInfo())
                    .result(syncResult.result())
                    .build();

            createdLogs.add(syncJobLogRepository.save(log));
        }

        log.info("{}Í±¥Ïùò ÎèôÍ∏∞Ìôî ÏûëÏóÖ Î°úÍ∑∏Î•º Í∏∞Î°ùÌïòÏòÄÏäµÎãàÎã§.", createdLogs.size());
        return createdLogs;
    }

    @Override
    public CursorPageResponse<SyncJobLog> search(SyncJobQueryParams params) {
        QSyncJobLog syncJobLog = QSyncJobLog.syncJobLog;

        int size = params.getSize();
        BooleanBuilder condition = createFilterConditions(params);

        Long totalElements = queryFactory
                .select(syncJobLog.count())
                .from(syncJobLog)
                .where(condition)
                .fetchOne();

//        List<SyncJobLog> content = queryFactory
//                .selectFrom(syncJobLog)
//                .where(
//                        jobTypeEq(params.getJobType()),
//                        indexInfoIdEq(params.getIndexInfoId()),
//                        baseDateBetween(params.getBaseDateFrom(), params.getBaseDateTo()),
//                        workerEq(params.getWorker()),
//                        jobTimeBetween(params.getJobTimeFrom(), params.getJobTimeTo()),
//                        statusEq(params.getStatus()),
//                        cursorCondition(params.getCursor(), params.getSortField(), params.getSortDirection())
//                )
//                .orderBy(getOrderSpecifiers(params.getSortField(), params.getSortDirection()))
//                .limit(size + 1)
//                .fetch();

        List<SyncJobLog> content = queryFactory
                .selectFrom(syncJobLog)
                .where(condition, cursorCondition(params.getCursor(), params.getSortField(), params.getSortDirection()))
                .orderBy(getOrderSpecifiers(params.getSortField(), params.getSortDirection()))
                .limit(size + 1)
                .fetch();

        boolean hasNext = content.size() > size;
        String nextCursor = null;

        if(hasNext) {
            SyncJobLog lastElement = content.remove(size);
            nextCursor = generateCursor(lastElement, params.getSortField());
        }

        return new CursorPageResponse<>(content, nextCursor, size, totalElements, hasNext);
    }

    // --- ÎèôÏ†Å WHERE Ï†àÏùÑ ÏúÑÌïú Ìó¨Ìçº Î©îÏÑúÎìúÎì§ ---

    // üí° [Ï∂îÍ∞Ä] ÌïÑÌÑ∞ Ï°∞Í±¥ ÏÉùÏÑ± Î°úÏßÅÏùÑ Î≥ÑÎèÑ Î©îÏÑúÎìúÎ°ú Î∂ÑÎ¶¨ÌïòÏó¨ Ïû¨ÏÇ¨Ïö©
    private BooleanBuilder createFilterConditions(SyncJobQueryParams params) {
        BooleanBuilder builder = new BooleanBuilder();
        builder.and(jobTypeEq(params.getJobType()));
        builder.and(indexInfoIdEq(params.getIndexInfoId()));
        builder.and(baseDateBetween(params.getBaseDateFrom(), params.getBaseDateTo()));
        builder.and(workerEq(params.getWorker()));
        builder.and(jobTimeBetween(params.getJobTimeFrom(), params.getJobTimeTo()));
        builder.and(statusEq(params.getStatus()));
        return builder;
    }

    private BooleanExpression jobTypeEq(JobType jobType) {
        return jobType != null ? QSyncJobLog.syncJobLog.jobType.eq(jobType) : null;
    }

    private BooleanExpression indexInfoIdEq(Long indexInfoId) {
        return indexInfoId != null ? QSyncJobLog.syncJobLog.indexInfo.id.eq(indexInfoId) : null;
    }

    private BooleanExpression baseDateBetween(LocalDate from, LocalDate to) {
        if (from == null || to == null) return null;
        return QSyncJobLog.syncJobLog.targetDate.between(from, to);
    }

    private BooleanExpression workerEq(String worker) {
        return worker != null && !worker.isBlank() ? QSyncJobLog.syncJobLog.worker.eq(worker) : null;
    }

    private BooleanExpression jobTimeBetween(LocalDateTime from, LocalDateTime to) {
        if (from == null || to == null) return null;
        return QSyncJobLog.syncJobLog.jobTime.between(from, to);
    }

    private BooleanExpression statusEq(JobResult status) {
        return status != null ? QSyncJobLog.syncJobLog.result.eq(status) : null;
    }

    private BooleanExpression cursorCondition(String cursor, String sortField, String sortDirection) {
        if (cursor == null) {
            return null;
        }

        String[] parts = cursor.split("_");
        if (parts.length != 2) throw new IllegalArgumentException("Invalid cursor format");

        long lastId = Long.parseLong(parts[1]);
        QSyncJobLog syncJobLog = QSyncJobLog.syncJobLog;
        boolean isDesc = "desc".equalsIgnoreCase(sortDirection);

        if ("jobTime".equals(sortField)) {
            LocalDateTime lastJobTime = LocalDateTime.parse(parts[0]);
            if (isDesc) {
                return syncJobLog.jobTime.lt(lastJobTime)
                        .or(syncJobLog.jobTime.eq(lastJobTime).and(syncJobLog.id.lt(lastId)));
            } else {
                return syncJobLog.jobTime.gt(lastJobTime)
                        .or(syncJobLog.jobTime.eq(lastJobTime).and(syncJobLog.id.gt(lastId)));
            }
        } else { // "targetDate"
            LocalDate lastTargetDate = LocalDate.parse(parts[0]);
            if (isDesc) {
                return syncJobLog.targetDate.lt(lastTargetDate)
                        .or(syncJobLog.targetDate.eq(lastTargetDate).and(syncJobLog.id.lt(lastId)));
            } else {
                return syncJobLog.targetDate.gt(lastTargetDate)
                        .or(syncJobLog.targetDate.eq(lastTargetDate).and(syncJobLog.id.gt(lastId)));
            }
        }
    }

    // --- ÎèôÏ†Å ORDER BY Ï†àÏùÑ ÏúÑÌïú Ìó¨Ìçº Î©îÏÑúÎìú ---

    private OrderSpecifier<?>[] getOrderSpecifiers(String sortField, String sortDirection) {
        QSyncJobLog syncJobLog = QSyncJobLog.syncJobLog;
        boolean isAsc = "asc".equalsIgnoreCase(sortDirection);
        Order order = isAsc ? Order.ASC : Order.DESC;
        OrderSpecifier<Long> idOrder = new OrderSpecifier<>(order, syncJobLog.id);

        if ("jobTime".equals(sortField)) {
            OrderSpecifier<LocalDateTime> jobTimeOrder = new OrderSpecifier<>(order, syncJobLog.jobTime);
            return new OrderSpecifier[]{jobTimeOrder, idOrder};
        } else { // "targetDate"
            OrderSpecifier<LocalDate> targetDateOrder = new OrderSpecifier<>(order, syncJobLog.targetDate);
            return new OrderSpecifier[]{targetDateOrder, idOrder};
        }
    }

    // --- Îã§Ïùå Ïª§ÏÑú ÏÉùÏÑ±ÏùÑ ÏúÑÌïú Ìó¨Ìçº Î©îÏÑúÎìú ---
    private String generateCursor(SyncJobLog lastElement, String sortField) {
        if (lastElement == null) return null;

        String valuePart = "jobTime".equals(sortField)
                ? lastElement.getJobTime().toString()
                : lastElement.getTargetDate().toString();
        return valuePart + "_" + lastElement.getId();
    }
}
